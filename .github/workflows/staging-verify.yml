name: Staging Verify

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  staging-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Ensure admin check script is executable
        run: chmod +x backend/scripts/check_admin_endpoints.sh

      - name: Start backend (uvicorn) in background
        env:
          DATABASE_URL: sqlite:///./test_ci.sqlite
          GCS_BUCKET: test-bucket
          # dev fallback admin uid for TEST_TOKEN=faketoken1234 -> dev-faketoke
          ADMIN_UIDS: dev-faketoke
        run: |
          nohup uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          # wait for /health to be available
          n=0
          until curl -sSf http://localhost:8000/health >/dev/null; do
            n=$((n+1))
            if [ $n -gt 30 ]; then echo "uvicorn failed to start"; cat uvicorn.log; exit 1; fi
            sleep 1
          done

      - name: Run admin endpoint checks
        env:
          BASE_URL: http://localhost:8000
          TEST_TOKEN: faketoken1234
        run: bash backend/scripts/check_admin_endpoints.sh

      - name: Run backend pytest
        env:
          DATABASE_URL: sqlite:///./test_ci.sqlite
          GCS_BUCKET: test-bucket
          ADMIN_UIDS: dev-faketoke
        run: pytest -q backend/tests
